# 동시 요청 - 멀티 쓰레드

* 외부에서 요청이 들어오면 TCP/IP 로 WAS가 연결을 한 뒤, Servlet을 호출하는데,,, WAS에서 Servlet을 호출하는 녀석은 누구인가?
    * 정답: 쓰레드

## 쓰레드
* 쓰레드는 애플리케이션 코드를 하나하나 순차적으로 실행한다.
* 자바 메인 메서드를 처음 실행하면 main이라는 이름의 쓰레드가 실행한다.
* 쓰레드가 없이는 자바 애플리케이션 실행 불가능!!!
* 쓰레드는 한 번에 하나의 코드 라인만 수행할 수 있다.
* 동시 처리가 필요하면 쓰레드를 추가로 생성해야 한다.

### 단일 요청 (with Single thread)
* 쓰레드 1개여도 요청이 1개니까 문제 없이 처리됨

### 다중 요청 (with Single thread)
* 먼저 온 요청이 처리 중일 때 또 다른 요청이 온다면, 먼저 온 요청의 작업이 완료 될 때까지 쓰레드 대기가 걸리면서 timeout 오류 발생
* 위 문제를 해결하기 위한 방법으로 요청이 들어올 때마다 새로운 쓰레드를 생성하는 방법이 있다.

### 요청 마다 쓰레드 생성 시 장단점
#### 장점
* 동시 요청을 처리할 수 있다.
* 리소스(CPU, 메모리)가 혀용할 때까지 처리 가능
* 하나의 쓰레드가 지연되어도 나머지 쓰레드는 정상 동작한다.
#### 단점
* 쓰레드 생성 비용이 매우 비쌈
    * 요청이 올 때마다 쓰레드를 생성하면 응답 속도 늦어짐
* [컨텍스트 스위칭](#1-컨텍스트-스위칭-코어-하나가-여러-동작을-할-때-실제로-동시에-작업하는-것이-아니라-하나씩-돌아가면서-하는데-그-작업이-빠르게-돌아가서-동시에-진행되는-것처럼-보이는-것-근데-이때-작업-대상이-바뀌는-걸-컨텍스트-스위칭이라고-한다) 비용이 발생한다.
* 쓰레드 생성에 제한이 없어 요청이 많이 오면, CPU, 메모리 임계점을 넘어 서버가 죽을 수 있다.
* 단점 해결책 : 쓰레드 풀

## 쓰레드 풀
* WAS 내부에 쓰레드들을 미리 만들어서 두는 곳
* 필요한 쓰레드를 보관하고 관리한다.
* 쓰레드 풀에 생성 가능한 쓰레드의 최대치를 관리한다. 톰켓은 최대 200개 기본 설정 되어 있음(변경 가능함)

### 사용 과정
* 요청이 들어오고 쓰레드가 필요하면 쓰레드 풀 안에 있는 쓰레드를 꺼내다 사용하면 된다.
* 사용이 다 끝나고 종료되면 쓰레드를 쓰레드 풀에 다시 반납한다.
* 최대 쓰레드가 모두 사용중일 때 쓰레드가 더 필요하면, 기다리는 요청을 거절하거나 특정 숫자만큼 대기하도록 설정 가능하다.

### 장점
* 쓰레드가 미리 생성되어 있으므로, 쓰레드를 생성하고 종료하는 비용(CPU)이 절약되고, 응답 속도가 빠르다.
* 생성 가능한 쓰레드의 최대 치가 있으므로 너무 많은 요청이 들어와도 기존 요청은 안전하게 처리할 수 있다.

### tip
* WAS의 주요 튜닝 포인트는 **최대 쓰레드의 수(max thread)**이다.

#### 적절한 수 찾는 법
* 애플리케이션 로직의 복잡도, CPU, 메모리, IO리소스 상황에 따라 모두 다름
* 결국 **성능 테스트**를 해봐야 알 수 있다.
    * 최대한 실제 서비스와 유사하게 성능 테스트 시도

## ⭐ WAS의 멀테 쓰레드 지원
### 1. 멀티 쓰레드에 대한 부분은 WAS가 처리한다.
### 2. 개발자가 멀티 쓰레드 관련 코드를 신경쓰지 않아도 된다.
### 3. 개발자는 마치 싱글 쓰레드 프로그래밍을 하듯이 편하게 소스 코드를 개발하기만 하면 된다.
### 4. 멀티 쓰레드 환경이므로 싱글톤 객체(서블릿, 스프링 빈)는 주의해서 사용해야 한다.






---
##### [1] 컨텍스트 스위칭: 코어 하나가 여러 쓰레드 동작을 할 때 실제로 동시에 작업하는 것이 아니라 하나씩 돌아가면서 하는데 그 작업이 빠르게 돌아가서 동시에 진행되는 것처럼 보이는 것. 근데 이때 쓰레드가 전환되는 걸 컨텍스트 스위칭이라고 한다.


### Reference
https://www.inflearn.com/course/%EC%8A%A4%ED%94%84%EB%A7%81-mvc-1/dashboard